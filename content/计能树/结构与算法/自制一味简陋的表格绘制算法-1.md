title: 自制一味简陋的表格绘制算法（1）

// 图 - Excel表格

我遇到这样一种应用场景：需要在一个给定的GUI框架上，提供一套可以模拟Excel表格的绘制算法。而这个GUI框架，仅仅提供了非常基础的绘制能力：比如可以以画带颜色的矩形，以及可以填字。

所以这里的焦点就在 __“设计一个数据结构和算法行为，模拟出表格的性状"__。

表格这种东西，看上去横平竖直，几行几列，一目了然。画几个框框，按照坐标和大小各自排列一下，想必应该不难...吧。比如Word里可以快速插入一个N x M宫格的表格，Evernote里也能找到类型功能。

但结合Excel表格的实际案例看一下，以及根据现有薄弱的GUI绘图能力的限制，依然能找到一些面临挑战的点。

1. 稍微复杂点的表格，就会表现出“嵌套”的行为。即并不是每一个表格都是单元格（盛放非表格元素，比如最常见的就是文字）。而有些子格，同时也是一个有子行子列的容器格。
2. 单元格的尺寸与其盛放的文字长度之间有一定的关系。这个功能是Excel不需要具备的，但在这个应用场景中，是一个加分项。即，这种关系要达到一种 __“自适应性”__ 。当文字增多的时候，单元格要 __“自动适应”__ 这种变化，调整自己的宽度，使文字永远都优雅地落放在自己体内。
3. 同时还要考虑到，GUI框架的薄弱。这里需要指明的是，“这个GUI究竟是什么”并不重要，因为重点在于表格的设计。为了方便起见，这里给出了这个GUI的两个基础API的Lua版本：一个是绘矩形，一个是填字：

``` lua
MyGUI:rect(pos, size, color)
MyGUI:text(text, font_size, pos, color)
```

我花了几天粗制滥造了一味方案，期间拼拼补补，幸好最终没有落得 _“服之，卒”_ 的下场。下图是运行后得到的模拟开头处Excel表格的效果。

// - 图 - 模拟效果

于是我想回顾总结一下我对这个问题的思考。

注：以下代码示例的只言片语，均用Lua写成。

#### 关于“嵌套”
__“嵌套”__ 这个词反映在程序设计中，往往对应着两件事。于“数据结构”而言，它表达的是对 __“Tree(树)”__ 的需求；于“行为”而言，它又表达的是向 __ “Recursive Traverse(递归遍历)”__ 靠拢。所以大体上，如果要实现“嵌套”这种功能，只要设计一个树型结构表达表格，并依次递归处理子孩子，在主线上就应该偏差不了太多。

确定了大方向，接下来的一个问题可能就是思考”递归遍历每一个孩子时，应该做什么”。

我想到的第一点，是计算当事者的Width(宽度)和Height(高度)。然而鉴于上文中第2点提到的 __“自适应性”__ 需求 ，这个问题的求解稍费周折。因为，处于叶子节点的单元格的尺寸，是由其放置的文字长度以及字体大小共同决定的；而它的尺寸，又间接影响了容纳它的处于父节点的容器格的尺寸。此次层层外推，最终形成了最外一层的大表格的尺寸。

关于 __“文字长度和字体大小影响单元格尺寸“__ 的问题，我们暂且一放，稍后再去细想如何实现。现在暂时假设这一步已经完成。那么，现在关注的问题便是如何处理由子格尺寸影响父格尺寸，并层层外推的问题。

这个凭直觉，就可意识到这是个构架在 __”深度优先递归遍历”__ 上的技法。所谓 __“深度优先”__ ，就是先遍历计算子格，再遍历计算父格。这个顺序和我们的诉求是一致的。

那么，子格是如何影响父格的呢？细想一下，会发现这个问题模型的一些“约束规律”。即，表格不是随便切分的，一般只有两种分法：要么竖着切（像这样 "|"），要么横着切（像这样 “-”）。而无论哪一种切分，对构成宽度和高度的两边而言，都有影响。比如，假设是竖着切的，那么能够肯定的是，其新切分出的每一个子格的高度，都与父格的高度相同；而父格的宽度，等于各个子格宽度之和。反过来横着切的话，就变成每个子格的宽度都等于父格宽度，而父格高度等于所有子格高度之和。你在图纸上画画，看是不是这样。__这种约束条件（也可视作一种规律，亦或业务逻辑的本质），就是经常在程序设计中，作为抽象设计方案的一种依据。__

不过由于这里的算法顺序是 __"先求得子格尺寸再决定父格尺寸"__ ，那么作为能影响子格其中一边大小的父格的对应边，无法在不知道子格的情况下事先知道自己的大小。这便是矛盾的地方，有点陷入了互相依赖之中。解决的办法其实也很好办：先遍历完所有子格的尺寸，然后考察“不变”的那边（对竖分而言是高度，而横分而言是宽度），找出最大值作为赋给父格对应边的值。然后，再将这个值赋给孩子中的其他兄弟姐妹。这样就完成了对“不变边”的求解。

而对另一边的处理就简单多了，直接累加所有子格的对应边，其和就是父格的对应边的值。

但是，到这里为止，这里还埋了一颗雷在其中。为简化算法模型，暂且不表。事后看情况在讨论。

// 未完待续
